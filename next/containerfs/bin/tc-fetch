#!/bin/bash

set -euo pipefail
set -x



# Get latest release, aiming for stability, rather than using a random commit on
# the 3.3.5 branch. TrinityCore mixes 335 and 837 releases, so we cannot just
# grab the first or latest entry. Using jq, grab all the tags with "TDB335" and
# return the first one (latest).
LATEST_RELEASE_TAG=$( \
  curl --silent "https://api.github.com/repos/TrinityCore/TrinityCore/releases" \
    | jq -r '[.[].tag_name | select(test("TDB335"))] | first' \
)

[ -d "/hostfs/tc-server/source/.git" ] && {
  # Update if it exists, keeping it shallow
  # https://stackoverflow.com/a/41081908
  cd /hostfs/tc-server/source
  git fetch --tags --depth 1
  git reset --hard $LATEST_RELEASE_TAG
  exit 0
} || {
  # Clone if fresh
  git clone \
    --depth 1 \
    -b $LATEST_RELEASE_TAG \
    git://github.com/TrinityCore/TrinityCore.git \
    /hostfs/tc-server/source
  exit 0
}
